<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FFMPEG VIDEO TOOL</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&display=swap');

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Space Mono', monospace;
        }

        body {
            background: #000;
            min-height: 100vh;
            padding: 20px;
            color: #fff;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        h1 {
            text-align: center;
            color: #fff;
            margin-bottom: 10px;
            font-size: 2.5em;
            font-weight: 700;
            letter-spacing: 2px;
            text-transform: uppercase;
        }

        .subtitle {
            text-align: center;
            color: #fff;
            margin-bottom: 30px;
            font-size: 0.75em;
            letter-spacing: 1px;
            text-transform: uppercase;
            opacity: 0.8;
        }

        .drop-zone {
            border: 3px solid #fff;
            padding: 60px 40px;
            text-align: center;
            background: #000;
            transition: none;
            cursor: pointer;
            margin-bottom: 30px;
        }

        .drop-zone:hover {
            background: #fff;
            color: #000;
        }

        .drop-zone.dragover {
            background: #fff;
            color: #000;
        }

        .drop-zone.has-file {
            border-color: #fff;
            background: #fff;
            color: #000;
        }

        .drop-icon {
            font-size: 4em;
            margin-bottom: 15px;
        }

        .drop-text {
            font-size: 1.3em;
            margin-bottom: 10px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .drop-subtext {
            font-size: 0.75em;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            opacity: 0.8;
        }

        #fileInput {
            display: none;
        }

        .file-info {
            display: none;
            background: #fff;
            border: 2px solid #000;
            padding: 20px;
            margin-bottom: 20px;
            color: #000;
        }

        .file-info.active {
            display: block;
        }

        .file-name {
            font-weight: 700;
            color: #000;
            font-size: 1.1em;
            margin-bottom: 5px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .file-size {
            color: #000;
            font-size: 0.75em;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            opacity: 0.7;
        }

        .presets-section {
            margin: 30px 0;
        }

        .preset-category {
            margin-bottom: 25px;
        }

        .category-title {
            font-size: 0.9em;
            font-weight: 700;
            color: #fff;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 2px solid #fff;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .preset-buttons {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 12px;
        }

        .preset-btn {
            background: #000;
            color: #fff;
            border: 2px solid #fff;
            padding: 15px 20px;
            font-size: 0.85em;
            font-weight: 700;
            cursor: pointer;
            transition: none;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .preset-btn:hover {
            background: #fff;
            color: #000;
        }

        .preset-btn:active {
            background: #fff;
            color: #000;
        }

        .preset-btn:disabled {
            background: #333;
            color: #666;
            border-color: #666;
            cursor: not-allowed;
        }

        .progress-section {
            display: none;
            background: #000;
            border: 2px solid #fff;
            padding: 20px;
            margin: 20px 0;
        }

        .progress-section.active {
            display: block;
        }

        .progress-bar-container {
            background: #000;
            border: 2px solid #fff;
            height: 30px;
            overflow: hidden;
            margin-bottom: 10px;
        }

        .progress-bar {
            height: 100%;
            background: #fff;
            width: 0%;
            transition: width 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #000;
            font-weight: 700;
            font-size: 0.75em;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .progress-text {
            color: #fff;
            text-align: center;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-size: 0.85em;
        }

        .output-section {
            display: none;
            background: #fff;
            border: 2px solid #000;
            padding: 20px;
            margin-top: 20px;
            color: #000;
        }

        .output-section.active {
            display: block;
        }

        .output-title {
            font-size: 1.1em;
            font-weight: 700;
            color: #000;
            margin-bottom: 15px;
            text-align: center;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .video-preview {
            width: 100%;
            max-height: 500px;
            margin-bottom: 15px;
            background: #000;
            border: 2px solid #000;
        }

        .download-btn {
            width: 100%;
            background: #000;
            color: #fff;
            border: 2px solid #000;
            padding: 18px;
            font-size: 0.9em;
            font-weight: 700;
            cursor: pointer;
            transition: none;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .download-btn:hover {
            background: #fff;
            color: #000;
        }

        .reset-btn {
            width: 100%;
            background: #fff;
            color: #000;
            border: 2px solid #000;
            padding: 12px;
            font-size: 0.85em;
            font-weight: 700;
            cursor: pointer;
            transition: none;
            margin-top: 10px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .reset-btn:hover {
            background: #000;
            color: #fff;
        }

        .error-section {
            display: none;
            background: #000;
            border: 2px solid #fff;
            padding: 20px;
            margin: 20px 0;
            color: #fff;
        }

        .error-section.active {
            display: block;
        }

        .error-title {
            font-weight: 700;
            font-size: 1em;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        #errorMessage {
            line-height: 1.6;
            font-size: 0.85em;
        }

        .info-box {
            background: #fff;
            border: 2px solid #000;
            padding: 15px;
            margin-top: 30px;
            color: #000;
        }

        .info-box strong {
            display: block;
            margin-bottom: 8px;
            font-size: 0.9em;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .info-box ul {
            margin-left: 20px;
            line-height: 1.8;
            font-size: 0.85em;
        }

        @media (max-width: 768px) {
            .container {
                padding: 20px;
            }

            h1 {
                font-size: 1.8em;
            }

            .preset-buttons {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>FFMPEG VIDEO TOOL</h1>
        <p class="subtitle">Process videos in your browser / No upload required</p>

        <input type="file" id="fileInput" accept="video/*" style="display: none;">

        <div class="drop-zone" id="dropZone">
            <div class="drop-icon">▼</div>
            <div class="drop-text">Drag & Drop Video File</div>
            <div class="drop-subtext">or click to browse (max 2GB)</div>
        </div>

        <div class="file-info" id="fileInfo">
            <div class="file-name" id="fileName"></div>
            <div class="file-size" id="fileSize"></div>
        </div>

        <div class="presets-section" id="presetsSection" style="display: none;">
            <div class="preset-category">
                <div class="category-title">▶ Format Conversion</div>
                <div class="preset-buttons">
                    <button class="preset-btn" data-preset="copy-mp4">Copy to MP4 (Fast)</button>
                    <button class="preset-btn" data-preset="mp4">Convert to MP4</button>
                    <button class="preset-btn" data-preset="webm">Convert to WebM</button>
                    <button class="preset-btn" data-preset="avi">Convert to AVI</button>
                    <button class="preset-btn" data-preset="mov">Convert to MOV</button>
                </div>
            </div>

            <div class="preset-category">
                <div class="category-title">▶ Compression & Quality</div>
                <div class="preset-buttons">
                    <button class="preset-btn" data-preset="compress-web">Compress for Web</button>
                    <button class="preset-btn" data-preset="high-quality">High Quality MP4</button>
                    <button class="preset-btn" data-preset="low-size">Small File Size</button>
                </div>
            </div>

            <div class="preset-category">
                <div class="category-title">▶ Video Editing</div>
                <div class="preset-buttons">
                    <button class="preset-btn" data-preset="resize-1080p">Resize to 1080p</button>
                    <button class="preset-btn" data-preset="resize-720p">Resize to 720p</button>
                    <button class="preset-btn" data-preset="resize-480p">Resize to 480p</button>
                    <button class="preset-btn" data-preset="rotate-90">Rotate 90° CW</button>
                    <button class="preset-btn" data-preset="trim-30s">Trim First 30s</button>
                </div>
            </div>

            <div class="preset-category">
                <div class="category-title">▶ Audio Operations</div>
                <div class="preset-buttons">
                    <button class="preset-btn" data-preset="extract-audio">Extract Audio (MP3)</button>
                    <button class="preset-btn" data-preset="remove-audio">Remove Audio</button>
                    <button class="preset-btn" data-preset="boost-audio">Boost Audio +6dB</button>
                    <button class="preset-btn" data-preset="lower-audio">Lower Audio -6dB</button>
                </div>
            </div>
        </div>

        <div class="progress-section" id="progressSection">
            <div class="progress-bar-container">
                <div class="progress-bar" id="progressBar">
                    <span id="progressPercent">0%</span>
                </div>
            </div>
            <div class="progress-text" id="progressText">Initializing...</div>
        </div>

        <div class="error-section" id="errorSection">
            <div class="error-title">× ERROR</div>
            <div id="errorMessage"></div>
        </div>

        <div class="output-section" id="outputSection">
            <div class="output-title">✓ Processing Complete</div>
            <video class="video-preview" id="outputVideo" controls></video>
            <button class="download-btn" id="downloadBtn">Download Processed Video</button>
            <button class="reset-btn" id="resetBtn">Process Another Video</button>
        </div>

        <div class="info-box">
            <strong>▶ How It Works</strong>
            <ul>
                <li>All processing happens in your browser using WebAssembly</li>
                <li>Your videos never leave your computer - completely private</li>
                <li>First use loads FFmpeg (~22MB) - subsequent uses are faster</li>
                <li>Processing is slower than desktop apps (expect 20-50x slower)</li>
                <li>Works best with files under 500MB for reasonable processing times</li>
            </ul>
            <strong>▶ Tips for Best Results</strong>
            <ul>
                <li>Try "Copy to MP4 (Fast)" first - fastest option, no re-encoding</li>
                <li>For large files or complex codecs (HEVC/H265), use simpler presets first</li>
                <li>If you get memory errors, try with a smaller file or lower resolution</li>
                <li>Screen recordings work best with "Copy to MP4" or "Compress for Web"</li>
            </ul>
        </div>
    </div>

    <script src="/js/ffmpeg.js"></script>
    <script>
        // Wait for FFmpeg to be available
        let FFmpeg;

        function initFFmpegLibrary() {
            if (typeof FFmpegWASM !== 'undefined') {
                FFmpeg = FFmpegWASM.FFmpeg;
                console.log('FFmpeg loaded successfully');
            } else {
                console.error('FFmpeg not found');
            }
        }

        // Helper function to read file as Uint8Array
        async function fileToUint8Array(file) {
            return new Uint8Array(await file.arrayBuffer());
        }

        // Try to initialize immediately
        initFFmpegLibrary();

        // Also try after a short delay if not available
        if (!FFmpeg) {
            setTimeout(initFFmpegLibrary, 100);
        }

        // State
        let ffmpeg = null;
        let inputFile = null;
        let inputFileName = '';
        let outputData = null;
        let outputFileName = '';
        let isProcessing = false;

        // Elements
        const dropZone = document.getElementById('dropZone');
        const fileInput = document.getElementById('fileInput');
        const fileInfo = document.getElementById('fileInfo');
        const fileName = document.getElementById('fileName');
        const fileSize = document.getElementById('fileSize');
        const presetsSection = document.getElementById('presetsSection');
        const progressSection = document.getElementById('progressSection');
        const progressBar = document.getElementById('progressBar');
        const progressPercent = document.getElementById('progressPercent');
        const progressText = document.getElementById('progressText');
        const errorSection = document.getElementById('errorSection');
        const errorMessage = document.getElementById('errorMessage');
        const outputSection = document.getElementById('outputSection');
        const outputVideo = document.getElementById('outputVideo');
        const downloadBtn = document.getElementById('downloadBtn');
        const resetBtn = document.getElementById('resetBtn');
        const presetBtns = document.querySelectorAll('.preset-btn');

        // Debug: Log element status
        console.log('Elements found:', {
            dropZone: !!dropZone,
            fileInput: !!fileInput
        });

        // FFmpeg presets (map 0:a? makes audio optional for videos without audio)
        const presets = {
            'copy-mp4': { args: ['-i', 'input', '-c', 'copy', 'output.mp4'], output: 'output.mp4' },
            'mp4': { args: ['-i', 'input', '-map', '0:v', '-map', '0:a?', '-c:v', 'libx264', '-c:a', 'aac', 'output.mp4'], output: 'output.mp4' },
            'webm': { args: ['-i', 'input', '-map', '0:v', '-map', '0:a?', '-c:v', 'libvpx-vp9', '-c:a', 'libopus', 'output.webm'], output: 'output.webm' },
            'avi': { args: ['-i', 'input', '-map', '0:v', '-map', '0:a?', '-c:v', 'mpeg4', '-c:a', 'mp3', 'output.avi'], output: 'output.avi' },
            'mov': { args: ['-i', 'input', '-map', '0:v', '-map', '0:a?', '-c:v', 'libx264', '-c:a', 'aac', 'output.mov'], output: 'output.mov' },
            'compress-web': { args: ['-i', 'input', '-map', '0:v', '-map', '0:a?', '-c:v', 'libx264', '-crf', '28', '-preset', 'fast', '-c:a', 'aac', '-b:a', '128k', 'output.mp4'], output: 'output.mp4' },
            'high-quality': { args: ['-i', 'input', '-map', '0:v', '-map', '0:a?', '-c:v', 'libx264', '-crf', '18', '-preset', 'slow', '-c:a', 'aac', '-b:a', '256k', 'output.mp4'], output: 'output.mp4' },
            'low-size': { args: ['-i', 'input', '-map', '0:v', '-map', '0:a?', '-c:v', 'libx264', '-crf', '32', '-preset', 'fast', '-c:a', 'aac', '-b:a', '96k', 'output.mp4'], output: 'output.mp4' },
            'resize-1080p': { args: ['-i', 'input', '-map', '0:v', '-map', '0:a?', '-vf', 'scale=-2:1080', '-c:a', 'copy', 'output.mp4'], output: 'output.mp4' },
            'resize-720p': { args: ['-i', 'input', '-map', '0:v', '-map', '0:a?', '-vf', 'scale=-2:720', '-c:a', 'copy', 'output.mp4'], output: 'output.mp4' },
            'resize-480p': { args: ['-i', 'input', '-map', '0:v', '-map', '0:a?', '-vf', 'scale=-2:480', '-c:a', 'copy', 'output.mp4'], output: 'output.mp4' },
            'rotate-90': { args: ['-i', 'input', '-map', '0:v', '-map', '0:a?', '-vf', 'transpose=1', '-c:a', 'copy', 'output.mp4'], output: 'output.mp4' },
            'trim-30s': { args: ['-i', 'input', '-map', '0', '-t', '30', '-c', 'copy', 'output.mp4'], output: 'output.mp4' },
            'extract-audio': { args: ['-i', 'input', '-vn', '-c:a', 'libmp3lame', '-q:a', '2', 'output.mp3'], output: 'output.mp3' },
            'remove-audio': { args: ['-i', 'input', '-an', '-c:v', 'copy', 'output.mp4'], output: 'output.mp4' },
            'boost-audio': { args: ['-i', 'input', '-af', 'volume=6dB', '-c:v', 'copy', 'output.mp4'], output: 'output.mp4' },
            'lower-audio': { args: ['-i', 'input', '-af', 'volume=-6dB', '-c:v', 'copy', 'output.mp4'], output: 'output.mp4' },
        };

        // Initialize FFmpeg
        async function loadFFmpeg() {
            if (ffmpeg) return;

            progressSection.classList.add('active');
            updateProgress(10, 'Loading FFmpeg.wasm...');

            try {
                // Check if FFmpeg is available
                if (!FFmpeg) {
                    throw new Error('FFmpeg library not loaded. Please refresh the page.');
                }

                ffmpeg = new FFmpeg();

                ffmpeg.on('log', ({ message }) => {
                    console.log(message);
                });

                ffmpeg.on('progress', ({ progress, time }) => {
                    const percent = Math.round(progress * 100);
                    updateProgress(percent, `Processing... ${(time / 1000000).toFixed(1)}s`);
                });

                // Load FFmpeg from local files (no CORS issues)
                await ffmpeg.load({
                    coreURL: '/js/ffmpeg-core.js',
                    wasmURL: '/ffmpeg-core.wasm',
                    workerURL: '/js/ffmpeg-core.worker.js'
                });

                updateProgress(100, 'FFmpeg loaded successfully!');
            } catch (error) {
                showError('Failed to load FFmpeg: ' + error.message);
                console.error('FFmpeg load error:', error);
                throw error;
            }
        }

        // File handling
        dropZone.addEventListener('click', (e) => {
            console.log('Drop zone clicked');
            if (fileInput) {
                console.log('Triggering file input');
                fileInput.click();
            } else {
                console.error('File input not found');
            }
        });

        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.classList.add('dragover');
        });

        dropZone.addEventListener('dragleave', () => {
            dropZone.classList.remove('dragover');
        });

        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleFile(files[0]);
            }
        });

        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                handleFile(e.target.files[0]);
            }
        });

        function handleFile(file) {
            if (!file.type.startsWith('video/')) {
                showError('Please select a video file');
                return;
            }

            if (file.size > 2 * 1024 * 1024 * 1024) {
                showError('File is too large. Maximum size is 2GB.');
                return;
            }

            inputFile = file;
            inputFileName = file.name;

            fileName.textContent = `▶ ${file.name}`;
            fileSize.textContent = `Size: ${formatFileSize(file.size)}`;

            dropZone.classList.add('has-file');
            fileInfo.classList.add('active');
            presetsSection.style.display = 'block';
            hideError();
            hideOutput();
        }

        // Preset buttons
        presetBtns.forEach(btn => {
            btn.addEventListener('click', async () => {
                if (isProcessing || !inputFile) return;

                const presetName = btn.dataset.preset;
                const preset = presets[presetName];

                if (!preset) {
                    showError('Invalid preset');
                    return;
                }

                await processVideo(preset);
            });
        });

        // Process video
        async function processVideo(preset) {
            if (isProcessing) return;

            isProcessing = true;
            disableButtons(true);
            hideError();
            hideOutput();
            progressSection.classList.add('active');

            try {
                // Load FFmpeg if not loaded
                if (!ffmpeg) {
                    await loadFFmpeg();
                }

                updateProgress(20, 'Loading video file...');

                // Write input file to FFmpeg filesystem
                const fileData = await fileToUint8Array(inputFile);
                await ffmpeg.writeFile('input', fileData);

                updateProgress(30, 'Processing video...');

                // Run FFmpeg command
                console.log('Running FFmpeg with args:', preset.args);
                await ffmpeg.exec(preset.args);
                console.log('FFmpeg exec completed');

                updateProgress(90, 'Reading output file...');

                // Check if output file exists
                console.log('Checking for output file:', preset.output);
                const files = await ffmpeg.listDir('/');
                console.log('Files in root:', files);

                // Read output file
                console.log('Reading output file:', preset.output);
                const data = await ffmpeg.readFile(preset.output);
                console.log('File read successfully, size:', data.length);

                // Verify it's a valid Uint8Array
                if (!data || data.length === 0) {
                    throw new Error('Output file is empty');
                }

                outputData = data;
                outputFileName = preset.output;

                updateProgress(100, 'Complete!');

                // Show output
                showOutput(data, preset.output);

            } catch (error) {
                const errorMsg = error?.message || error?.toString() || 'Unknown error occurred';
                let userMsg = 'Processing failed: ' + errorMsg;

                // Provide helpful hints for common errors
                if (errorMsg.includes('out of bounds') || errorMsg.includes('memory')) {
                    userMsg += '\n\nTip: This error often occurs with large files or complex codecs. Try:\n- A smaller video file\n- "Convert to MP4" preset (simpler encoding)\n- Reducing the video resolution first';
                }

                showError(userMsg);
                console.error('Processing error:', error);
            } finally {
                isProcessing = false;
                disableButtons(false);
                setTimeout(() => {
                    progressSection.classList.remove('active');
                }, 2000);
            }
        }

        // Show output
        function showOutput(data, filename) {
            const mimeType = getMimeType(filename);
            const blob = new Blob([data.buffer], { type: mimeType });
            const url = URL.createObjectURL(blob);

            if (mimeType.startsWith('video/')) {
                outputVideo.style.display = 'block';
                outputVideo.src = url;
            } else {
                outputVideo.style.display = 'none';
            }

            outputSection.classList.add('active');
        }

        // Download button
        downloadBtn.addEventListener('click', () => {
            if (!outputData) return;

            const blob = new Blob([outputData.buffer], { type: getMimeType(outputFileName) });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = outputFileName;
            a.click();
            URL.revokeObjectURL(url);
        });

        // Reset button
        resetBtn.addEventListener('click', () => {
            inputFile = null;
            inputFileName = '';
            outputData = null;
            outputFileName = '';

            fileInput.value = '';
            dropZone.classList.remove('has-file');
            fileInfo.classList.remove('active');
            presetsSection.style.display = 'none';
            hideOutput();
            hideError();
        });

        // Helper functions
        function updateProgress(percent, text) {
            progressBar.style.width = `${percent}%`;
            progressPercent.textContent = `${percent}%`;
            progressText.textContent = text;
        }

        function showError(message) {
            // Convert newlines to <br> for display
            errorMessage.innerHTML = message.replace(/\n/g, '<br>');
            errorSection.classList.add('active');
        }

        function hideError() {
            errorSection.classList.remove('active');
        }

        function hideOutput() {
            outputSection.classList.remove('active');
        }

        function disableButtons(disabled) {
            presetBtns.forEach(btn => btn.disabled = disabled);
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
        }

        function getMimeType(filename) {
            const ext = filename.split('.').pop().toLowerCase();
            const mimeTypes = {
                'mp4': 'video/mp4',
                'webm': 'video/webm',
                'avi': 'video/x-msvideo',
                'mov': 'video/quicktime',
                'mp3': 'audio/mpeg',
            };
            return mimeTypes[ext] || 'application/octet-stream';
        }
    </script>
</body>
</html>